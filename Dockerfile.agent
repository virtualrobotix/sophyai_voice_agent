# Voice Agent - Agent Container
FROM python:3.11-slim

# Installa dipendenze sistema
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    ffmpeg \
    libsndfile1 \
    curl \
    espeak-ng \
    git \
    && rm -rf /var/lib/apt/lists/*

# Directory di lavoro
WORKDIR /app

# Copia requirements e installa dipendenze Python
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copia il codice
COPY . .

# Crea directory per modelli
RUN mkdir -p /app/models/piper /app/models/huggingface

# Pre-scarica i modelli Whisper durante il build
ENV HF_HOME=/app/models/huggingface
RUN python -c "from faster_whisper import WhisperModel; WhisperModel('base', device='cpu', compute_type='int8')" || true
RUN python -c "from faster_whisper import WhisperModel; WhisperModel('small', device='cpu', compute_type='int8')" || true

# VibeVoice viene eseguito esternamente (tts_server.py sul host con GPU/MPS)
# Non serve installarlo nel container, il Docker chiama il server via HTTP

# Variabili d'ambiente di default
ENV PYTHONUNBUFFERED=1
ENV LIVEKIT_URL=ws://livekit:7880
ENV OLLAMA_HOST=http://host.docker.internal:11434
ENV WHISPER_MODEL=base
ENV WHISPER_LANGUAGE=it
ENV WHISPER_DEVICE=cpu
ENV DEFAULT_TTS=edge
ENV LOG_LEVEL=INFO

# Comando di avvio (start per modalit√† produzione)
CMD ["python", "-m", "agent.main", "start"]

