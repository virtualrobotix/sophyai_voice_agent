services:
  # PostgreSQL per persistenza configurazioni e chat
  postgres:
    image: postgres:16-alpine
    container_name: voice-agent-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=voiceagent
      - POSTGRES_USER=voiceagent
      - POSTGRES_PASSWORD=voiceagent_pwd
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./db/schema.sql:/docker-entrypoint-initdb.d/schema.sql:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U voiceagent -d voiceagent"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - voiceagent

  # Redis per LiveKit (locale)
  redis:
    image: redis:7-alpine
    container_name: livekit-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - voiceagent

  # Web Server (Frontend + API) con HTTPS
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: voice-agent-web
    restart: unless-stopped
    ports:
      - "8080:8080"     # HTTP
      - "8443:8443"     # HTTPS
    environment:
      # LIVEKIT_URL: usa il tuo IP di rete locale per permettere connessioni da altri dispositivi
      # Esempio: LIVEKIT_URL=ws://192.168.1.100:7880
      - LIVEKIT_URL=${LIVEKIT_URL:-ws://0.0.0.0:7880}
      - LIVEKIT_INTERNAL_URL=ws://host.docker.internal:7880
      # IP del server per costruire URL dinamicamente
      # IMPORTANTE: Imposta con il tuo IP di rete locale (es. 192.168.1.100)
      - SERVER_IP=${SERVER_IP:-host.docker.internal}
      - LIVEKIT_API_KEY=devkey
      - LIVEKIT_API_SECRET=secret_dev_key_change_in_production
      - OLLAMA_HOST=http://host.docker.internal:11434
      - OLLAMA_MODEL=devstral-small-2
      - WHISPER_MODEL=small
      - DEFAULT_TTS=edge
      - WEB_PORT=8443
      - LOG_LEVEL=INFO
      - HF_HOME=/app/models/huggingface
      - DATABASE_URL=postgresql://voiceagent:voiceagent_pwd@postgres:5432/voiceagent
    volumes:
      - ./models:/app/models
      - ./certs:/app/certs:ro
      - ./config:/app/config
      - ./web:/app/web:ro  # Monta directory web per vedere modifiche immediate
      - ./server.py:/app/server.py:ro  # Server con nuove API
      - ./db:/app/db:ro  # Modulo database
      - /var/run/docker.sock:/var/run/docker.sock  # Per permettere restart agent
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - voiceagent
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # LiveKit SIP Bridge - per chiamate telefoniche
  sip:
    image: livekit/sip:latest
    container_name: livekit-sip
    restart: unless-stopped
    ports:
      - "5060:5060/udp"   # SIP UDP
      - "5060:5060/tcp"   # SIP TCP
      - "5061:5061/tcp"   # SIP TLS
      - "10000-10100:10000-10100/udp"  # RTP media ports
    environment:
      - LIVEKIT_URL=ws://host.docker.internal:7880
      - LIVEKIT_API_KEY=devkey
      - LIVEKIT_API_SECRET=secret_dev_key_change_in_production
      - SIP_PORT=5060
      - SIP_PORT_TLS=5061
      - RTP_PORT_LOW=10000
      - RTP_PORT_HIGH=10100
    volumes:
      - ./sip-config.yaml:/etc/livekit-sip/config.yaml:ro
    networks:
      - voiceagent
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Voice Agent - si connette a LiveKit locale
  agent:
    build:
      context: .
      dockerfile: Dockerfile.agent
    container_name: voice-agent-worker
    restart: unless-stopped
    environment:
      - LIVEKIT_URL=ws://host.docker.internal:7880
      - LIVEKIT_API_KEY=devkey
      - LIVEKIT_API_SECRET=secret_dev_key_change_in_production
      - OLLAMA_HOST=http://host.docker.internal:11434
      - OLLAMA_MODEL=devstral-small-2
      - WHISPER_MODEL=small
      - WHISPER_LANGUAGE=it
      - WHISPER_SERVER_URL=http://host.docker.internal:8091
      - TTS_SERVER_URL=http://host.docker.internal:8092
      - DEFAULT_TTS=edge
      - LOG_LEVEL=INFO
      - HF_HOME=/app/models/huggingface
      - XDG_CACHE_HOME=/app/models/cache
      - DATABASE_URL=postgresql://voiceagent:voiceagent_pwd@postgres:5432/voiceagent
    volumes:
      - ./models:/app/models
      - ./config:/app/config
      - ./agent:/app/agent:ro
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - voiceagent
    extra_hosts:
      - "host.docker.internal:host-gateway"

networks:
  voiceagent:
    driver: bridge

volumes:
  redis_data:
  postgres_data:
