<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SophyAi - Impostazioni</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --accent: #8b5cf6;
            --accent-glow: rgba(139, 92, 246, 0.4);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: rgba(255, 255, 255, 0.08);
            --radius: 16px;
            --radius-sm: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent), #c084fc);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .logo-text { font-size: 1.2rem; font-weight: 700; }
        .logo-subtitle { font-size: 0.75rem; color: var(--text-muted); }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .back-btn:hover { background: var(--accent); border-color: var(--accent); }

        /* Tabs */
        .tabs-container {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 24px;
        }

        .tabs {
            display: flex;
            gap: 4px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .tab {
            padding: 16px 24px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            font-family: inherit;
        }

        .tab:hover { color: var(--text-primary); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }

        /* Tab Content */
        .tab-content {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }

        .tab-content.active { display: block; }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .card-icon {
            width: 40px;
            height: 40px;
            background: rgba(139, 92, 246, 0.15);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .card-title { font-size: 1.1rem; font-weight: 600; }

        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: var(--text-secondary); }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-textarea { min-height: 120px; resize: vertical; }

        /* Model Grid */
        .model-grid { display: grid; gap: 12px; max-height: 400px; overflow-y: auto; }

        .model-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .model-item:hover { border-color: var(--accent); }
        .model-item.selected { border-color: var(--accent); background: rgba(139, 92, 246, 0.1); }

        .model-info { flex: 1; }
        .model-name { font-weight: 600; margin-bottom: 4px; }
        .model-badges { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 6px; }
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
        }
        .badge-vision { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; color: #60a5fa; }
        .badge-tools { background: rgba(249, 115, 22, 0.2); border-color: #f97316; color: #fb923c; }
        .badge-json { background: rgba(16, 185, 129, 0.2); border-color: #10b981; color: #34d399; }
        .badge-context { background: rgba(139, 92, 246, 0.2); border-color: #8b5cf6; color: #a78bfa; }
        .model-desc { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px; }
        .model-cost { font-size: 0.8rem; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; }

        /* Provider Toggle */
        .provider-toggle {
            display: flex;
            background: var(--bg-secondary);
            border-radius: var(--radius-sm);
            padding: 4px;
            margin-bottom: 20px;
        }

        .provider-btn {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .provider-btn.active { background: var(--accent); color: white; }

        /* Search */
        .search-container {
            position: relative;
            margin-bottom: 16px;
        }

        .search-input {
            width: 100%;
            padding: 12px 12px 12px 40px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        /* Sort */
        .sort-select {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .stat-box {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: var(--radius-sm);
            border-left: 3px solid var(--accent);
        }

        .stat-box.stt { border-left-color: #22c55e; }
        .stat-box.llm { border-left-color: #f59e0b; }
        .stat-box.tts { border-left-color: #8b5cf6; }
        .stat-box.latency { border-left-color: #ef4444; }

        .stat-label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; }
        .stat-value { font-size: 1.8rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
        .stat-value.stt { color: #22c55e; }
        .stat-value.llm { color: #f59e0b; }
        .stat-value.tts { color: #8b5cf6; }
        .stat-value.latency { color: #ef4444; }
        .stat-unit { font-size: 0.9rem; color: var(--text-muted); }
        .stat-details { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary { background: var(--accent); color: white; }
        .btn-primary:hover { background: #7c3aed; }
        .btn-secondary { background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--accent); }

        .btn-group { display: flex; gap: 12px; margin-top: 16px; }

        /* API Key Input */
        .api-key-container {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .api-key-container .form-group { flex: 1; margin-bottom: 0; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 16px 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
        }

        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }

        /* Loading */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* TTS Options */
        .tts-grid { display: grid; gap: 12px; }

        .tts-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
        }

        .tts-option:hover { border-color: var(--accent); }
        .tts-option.selected { border-color: var(--accent); background: rgba(139, 92, 246, 0.1); }
        .tts-option-icon { font-size: 1.5rem; }
        .tts-option-info { flex: 1; }
        .tts-option-name { font-weight: 600; }
        .tts-option-desc { font-size: 0.85rem; color: var(--text-muted); }
        .tts-badge { font-size: 0.7rem; padding: 3px 8px; border-radius: 100px; font-weight: 600; }
        .tts-badge.local { background: rgba(16, 185, 129, 0.2); color: var(--success); }
        .tts-badge.cloud { background: rgba(245, 158, 11, 0.2); color: var(--warning); }

        /* TTS Test */
        .tts-test-area {
            margin-top: 20px;
            padding: 20px;
            background: rgba(139, 92, 246, 0.05);
            border-radius: 12px;
        }
        
        /* ElevenLabs Panel */
        .elevenlabs-panel {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
        }
        .voice-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
            padding: 4px;
        }
        .voice-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .voice-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--primary);
        }
        .voice-item.selected {
            background: rgba(139, 92, 246, 0.15);
            border-color: var(--primary);
        }
        .voice-item .voice-icon {
            font-size: 18px;
        }
        .voice-item .voice-info {
            flex: 1;
            min-width: 0;
        }
        .voice-item .voice-name {
            font-weight: 500;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .voice-item .voice-labels {
            font-size: 10px;
            color: var(--text-muted);
        }
        .voice-item .voice-preview {
            opacity: 0;
            padding: 4px;
            border-radius: 50%;
            transition: opacity 0.2s;
        }
        .voice-item:hover .voice-preview {
            opacity: 1;
        }
        
        /* Cost Slider */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: var(--bg-secondary);
            border-radius: 3px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.4);
            transition: transform 0.15s ease;
        }
        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.4);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo">
            <div class="logo-icon">S</div>
            <div>
                <div class="logo-text">SophyAi</div>
                <div class="logo-subtitle">Impostazioni</div>
            </div>
        </div>
        <a href="/" class="back-btn">‚Üê Torna alla Chat</a>
    </div>

    <!-- Tabs -->
    <div class="tabs-container">
        <div class="tabs">
            <button class="tab active" data-tab="stats" onclick="switchTab('stats')">üìä Statistiche</button>
            <button class="tab" data-tab="whisper" onclick="switchTab('whisper')">üé§ Whisper</button>
            <button class="tab" data-tab="llm" onclick="switchTab('llm')">üß† LLM</button>
            <button class="tab" data-tab="tts" onclick="switchTab('tts')">üîä TTS</button>
            <button class="tab" data-tab="voice" onclick="switchTab('voice')">üéôÔ∏è Voice</button>
        </div>
    </div>

    <!-- Stats Tab -->
    <div class="tab-content active" id="tab-stats">
        <div class="card">
            <div class="card-header">
                <div class="card-icon">‚ö°</div>
                <h2 class="card-title">Performance</h2>
            </div>
            <div class="stats-grid">
                <div class="stat-box stt">
                    <div class="stat-label">üé§ STT (Whisper)</div>
                    <div class="stat-value stt" id="stat-stt">--</div>
                    <div class="stat-unit">ms</div>
                    <div class="stat-details" id="stat-stt-detail">In attesa...</div>
                </div>
                <div class="stat-box llm">
                    <div class="stat-label">üß† LLM</div>
                    <div class="stat-value llm" id="stat-llm">--</div>
                    <div class="stat-unit">ms</div>
                    <div class="stat-details" id="stat-llm-detail">In attesa...</div>
                </div>
                <div class="stat-box tts">
                    <div class="stat-label">üîä TTS</div>
                    <div class="stat-value tts" id="stat-tts">--</div>
                    <div class="stat-unit">ms</div>
                    <div class="stat-details" id="stat-tts-detail">In attesa...</div>
                </div>
                <div class="stat-box latency">
                    <div class="stat-label">‚ö° Latenza E2E</div>
                    <div class="stat-value latency" id="stat-latency">--</div>
                    <div class="stat-unit">ms</div>
                    <div class="stat-details" id="stat-latency-detail">Domanda ‚Üí Risposta</div>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="resetStats()">üóëÔ∏è Reset Stats</button>
                <button class="btn btn-secondary" onclick="fetchStats()">üîÑ Aggiorna</button>
            </div>
        </div>
    </div>

    <!-- Whisper Tab -->
    <div class="tab-content" id="tab-whisper">
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üé§</div>
                <h2 class="card-title">Configurazione Whisper STT</h2>
            </div>
            
            <div class="form-group">
                <label class="form-label">Modello</label>
                <select class="form-select" id="whisper-model" onchange="saveWhisperSettings()">
                    <option value="tiny">Tiny (39M) - Velocissimo</option>
                    <option value="base">Base (74M) - Veloce</option>
                    <option value="small">Small (244M) - Bilanciato</option>
                    <option value="medium" selected>Medium (769M) - Preciso</option>
                    <option value="large-v3">Large-v3 (1.5B) - Massima precisione</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Lingua</label>
                <select class="form-select" id="whisper-language" onchange="saveWhisperSettings()">
                    <option value="it" selected>Italiano</option>
                    <option value="en">English</option>
                    <option value="es">Espa√±ol</option>
                    <option value="fr">Fran√ßais</option>
                    <option value="de">Deutsch</option>
                    <option value="zh">‰∏≠Êñá</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="whisper-auto-detect" onchange="saveWhisperSettings()">
                    Rilevamento automatico lingua
                </label>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveWhisperSettings()">üíæ Salva</button>
            </div>
        </div>
    </div>

    <!-- LLM Tab -->
    <div class="tab-content" id="tab-llm">
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üß†</div>
                <h2 class="card-title">Configurazione LLM</h2>
            </div>
            
            <!-- Provider Toggle -->
            <div class="provider-toggle">
                <button class="provider-btn active" data-provider="ollama" onclick="switchProvider('ollama')">
                    ü¶ô Ollama (Locale)
                </button>
                <button class="provider-btn" data-provider="openrouter" onclick="switchProvider('openrouter')">
                    üåê OpenRouter (Cloud)
                </button>
                <button class="provider-btn" data-provider="remote" onclick="switchProvider('remote')">
                    üñ•Ô∏è Server Remoto
                </button>
            </div>
            
            <!-- Ollama Section -->
            <div id="ollama-section">
                <div class="search-container">
                    <span class="search-icon">üîç</span>
                    <input type="text" class="search-input" id="ollama-search" placeholder="Cerca modello..." oninput="filterOllamaModels()">
                </div>
                <div class="model-grid" id="ollama-models">
                    <div class="loading"></div>
                </div>
            </div>
            
            <!-- OpenRouter Section -->
            <div id="openrouter-section" style="display: none;">
                <div class="api-key-container">
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="password" class="form-input" id="openrouter-key" placeholder="sk-or-...">
                    </div>
                    <button class="btn btn-primary" onclick="saveOpenRouterKey()">üíæ</button>
                </div>
                
                <div style="display: flex; gap: 12px; margin: 16px 0;">
                    <div class="search-container" style="flex: 1; margin-bottom: 0;">
                        <span class="search-icon">üîç</span>
                        <input type="text" class="search-input" id="openrouter-search" placeholder="Cerca modello..." oninput="searchOpenRouterModels()">
                    </div>
                    <select class="sort-select" id="openrouter-sort" onchange="filterAndRenderOpenRouter()">
                        <option value="name">Nome</option>
                        <option value="cost">Costo (min)</option>
                        <option value="cost_desc">Costo (max)</option>
                        <option value="context">Context (max)</option>
                    </select>
                </div>
                
                <div class="cost-slider-container" style="margin: 16px 0; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label style="font-weight: 500;">üí∞ Costo massimo</label>
                        <span id="max-cost-value" style="font-weight: 600; color: var(--primary);">$100.00</span>
                    </div>
                    <input type="range" id="openrouter-max-cost" min="0" max="100" value="100" step="0.5" 
                           style="width: 100%; cursor: pointer;" oninput="updateCostSlider()">
                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                        <span>$0 (Gratuiti)</span>
                        <span>$100/1M tokens</span>
                    </div>
                </div>
                
                <div class="model-grid" id="openrouter-models">
                    <div class="loading"></div>
                </div>
            </div>
            
            <!-- Remote Server Section -->
            <div id="remote-section" style="display: none;">
                <div class="form-group">
                    <label class="form-label">URL Server</label>
                    <input type="text" class="form-input" id="remote-server-url" placeholder="http://10.0.0.133:5006">
                    <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 4px; display: block;">
                        URL base del server LLM remoto (es. http://192.168.1.100:5006)
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Token di Autenticazione</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="password" class="form-input" id="remote-server-token" placeholder="mysecrettoken" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="toggleTokenVisibility()" title="Mostra/Nascondi">üëÅÔ∏è</button>
                    </div>
                    <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 4px; display: block;">
                        Bearer Token per l'autenticazione (opzionale)
                    </small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Collection</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" class="form-input" id="remote-server-collection" placeholder="fctsa" style="flex: 1;">
                        <button class="btn btn-secondary" onclick="loadRemoteCollections()" title="Carica collections">üîÑ</button>
                    </div>
                    <small style="color: var(--text-muted); font-size: 0.75rem; margin-top: 4px; display: block;">
                        Nome della collection/knowledge base da usare
                    </small>
                </div>
                
                <div id="remote-collections-list" style="display: none; margin: 12px 0;">
                    <label class="form-label">Collections disponibili:</label>
                    <div id="remote-collections-grid" class="model-grid" style="max-height: 150px; overflow-y: auto;">
                    </div>
                </div>
                
                <div class="btn-group" style="margin-top: 16px;">
                    <button class="btn btn-secondary" onclick="testRemoteServer()">
                        üîå Test Connessione
                    </button>
                    <button class="btn btn-primary" onclick="saveRemoteServer()">
                        üíæ Salva e Usa
                    </button>
                </div>
                
                <div id="remote-test-result" style="margin-top: 12px; display: none;">
                </div>
                
                <div class="info-box" style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--accent);">
                    <div style="font-weight: 600; margin-bottom: 8px;">üìã Formato API supportato</div>
                    <code style="font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--text-secondary); display: block; white-space: pre-wrap;">POST /chat
Content-Type: application/json
Authorization: Bearer &lt;token&gt;

{"message": "ciao", "collection": "fctsa"}</code>
                </div>
            </div>
        </div>
        
        <!-- Prompt Configuration -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üìù</div>
                <h2 class="card-title">System Prompt</h2>
            </div>
            
            <div class="form-group">
                <label class="form-label">Prompt di sistema</label>
                <textarea class="form-textarea" id="system-prompt" rows="8" placeholder="Inserisci il prompt di sistema..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Context Injection (informazioni aggiuntive)</label>
                <textarea class="form-textarea" id="context-injection" rows="4" placeholder="Informazioni extra da aggiungere al contesto..."></textarea>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="savePromptSettings()">üíæ Salva Prompt</button>
            </div>
        </div>
    </div>

    <!-- TTS Tab -->
    <div class="tab-content" id="tab-tts">
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üîä</div>
                <h2 class="card-title">Configurazione TTS</h2>
            </div>
            
            <div class="tts-grid" id="tts-grid">
                <div class="tts-option selected" data-engine="edge" onclick="selectTTS('edge')">
                    <span class="tts-option-icon">üéôÔ∏è</span>
                    <div class="tts-option-info">
                        <div class="tts-option-name">Edge TTS (Microsoft)</div>
                        <div class="tts-option-desc">Alta qualit√†, italiano naturale</div>
                    </div>
                    <span class="tts-badge cloud">Cloud</span>
                </div>
                
                <div class="tts-option" data-engine="kokoro" onclick="selectTTS('kokoro')">
                    <span class="tts-option-icon">üéµ</span>
                    <div class="tts-option-info">
                        <div class="tts-option-name">Kokoro TTS</div>
                        <div class="tts-option-desc">Alta qualit√†, multilingua (82M)</div>
                    </div>
                    <span class="tts-badge local">Self-Hosted</span>
                </div>
                
                <div class="tts-option" data-engine="piper" onclick="selectTTS('piper')">
                    <span class="tts-option-icon">üîà</span>
                    <div class="tts-option-info">
                        <div class="tts-option-name">Piper TTS</div>
                        <div class="tts-option-desc">Veloce e leggero</div>
                    </div>
                    <span class="tts-badge local">Self-Hosted</span>
                </div>
                
                <div class="tts-option" data-engine="vibevoice" onclick="selectTTS('vibevoice')">
                    <span class="tts-option-icon">üé§</span>
                    <div class="tts-option-info">
                        <div class="tts-option-name">VibeVoice (Microsoft)</div>
                        <div class="tts-option-desc">Espressivo, multi-speaker</div>
                    </div>
                    <span class="tts-badge local">Self-Hosted</span>
                </div>
                
                <div class="tts-option" data-engine="chatterbox" onclick="selectTTS('chatterbox')">
                    <span class="tts-option-icon">üé≠</span>
                    <div class="tts-option-info">
                        <div class="tts-option-name">Chatterbox</div>
                        <div class="tts-option-desc">Multilingua, voice cloning</div>
                    </div>
                    <span class="tts-badge local">Self-Hosted</span>
                </div>
                
                <div class="tts-option" data-engine="elevenlabs" onclick="selectTTS('elevenlabs')">
                    <span class="tts-option-icon">üåü</span>
                    <div class="tts-option-info">
                        <div class="tts-option-name">ElevenLabs</div>
                        <div class="tts-option-desc">Premium, ultra-realistico</div>
                    </div>
                    <span class="tts-badge cloud" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">Premium</span>
                </div>
            </div>
            
            <!-- ElevenLabs Configuration Panel -->
            <div id="elevenlabs-config" class="elevenlabs-panel" style="display: none;">
                <div class="card-header" style="padding: 0; margin-bottom: 16px;">
                    <div class="card-icon">üåü</div>
                    <h3 style="font-size: 16px; margin: 0;">Configurazione ElevenLabs</h3>
                </div>
                
                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="password" class="form-input" id="elevenlabs-key" placeholder="xi-...">
                        <button class="btn btn-primary" onclick="saveElevenLabsKey()">üíæ</button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Modello</label>
                    <select class="form-select" id="elevenlabs-model" onchange="saveElevenLabsSettings()">
                        <option value="eleven_multilingual_v2">Multilingual v2 (Migliore)</option>
                        <option value="eleven_turbo_v2_5">Turbo v2.5 (Veloce)</option>
                        <option value="eleven_turbo_v2">Turbo v2</option>
                        <option value="eleven_monolingual_v1">Monolingual v1 (Solo EN)</option>
                        <option value="eleven_flash_v2_5">Flash v2.5 (Streaming)</option>
                        <option value="eleven_flash_v2">Flash v2 (Streaming)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Voce</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                        <input type="text" class="form-input" id="elevenlabs-voice-search" placeholder="Cerca voce..." oninput="searchElevenLabsVoices()">
                        <button class="btn btn-secondary" onclick="loadElevenLabsVoices()">üîÑ</button>
                    </div>
                    <div class="voice-grid" id="elevenlabs-voices">
                        <div style="color: var(--text-muted); padding: 12px;">Inserisci API Key per caricare le voci</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Stability: <span id="stability-value">50%</span></label>
                    <input type="range" id="elevenlabs-stability" min="0" max="100" value="50" oninput="updateElevenLabsSlider('stability')">
                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted);">
                        <span>Variabile</span>
                        <span>Stabile</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Similarity Boost: <span id="similarity-value">75%</span></label>
                    <input type="range" id="elevenlabs-similarity" min="0" max="100" value="75" oninput="updateElevenLabsSlider('similarity')">
                    <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted);">
                        <span>Creativo</span>
                        <span>Fedele</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Style Exaggeration: <span id="style-value">0%</span></label>
                    <input type="range" id="elevenlabs-style" min="0" max="100" value="0" oninput="updateElevenLabsSlider('style')">
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="elevenlabs-boost" onchange="saveElevenLabsSettings()">
                        <span>Speaker Boost (migliora chiarezza)</span>
                    </label>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label">Lingua TTS</label>
                <select class="form-select" id="tts-language">
                    <option value="it" selected>Italiano</option>
                    <option value="en">English</option>
                    <option value="es">Espa√±ol</option>
                    <option value="fr">Fran√ßais</option>
                    <option value="de">Deutsch</option>
                </select>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveTTSSettings()">üíæ Salva</button>
            </div>
            
            <!-- TTS Test -->
            <div class="tts-test-area">
                <div class="form-group">
                    <label class="form-label">Testa TTS</label>
                    <textarea class="form-textarea" id="tts-test-text" rows="2">Ciao! Questo √® un test del TTS.</textarea>
                </div>
                <button class="btn btn-secondary" onclick="testTTS()">‚ñ∂Ô∏è Testa</button>
                <div id="tts-test-status" style="margin-top: 12px;"></div>
            </div>
        </div>
    </div>

    <!-- Voice Activation Tab -->
    <div class="tab-content" id="tab-voice">
        <div class="card">
            <div class="card-header">
                <div class="card-icon">üéôÔ∏è</div>
                <h2 class="card-title">Configurazione Voice Activation</h2>
            </div>
            
            <div class="form-group">
                <label class="form-label">Timeout "Hey Sophy" (secondi)</label>
                <input type="range" id="wake-timeout" min="5" max="60" value="20" 
                       style="width: 100%;" oninput="updateVoiceSlider('wake-timeout')">
                <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                    <span>5s</span>
                    <span id="wake-timeout-value" style="font-weight: 600; color: var(--accent);">20s</span>
                    <span>60s</span>
                </div>
                <small style="color: var(--text-muted); display: block; margin-top: 8px;">
                    Tempo di inattivit√† dopo il quale l'utente deve dire nuovamente "Hey Sophy"
                </small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Sensibilit√† VAD Barge-in</label>
                <input type="range" id="vad-threshold" min="10" max="200" value="40" 
                       style="width: 100%;" oninput="updateVoiceSlider('vad-threshold')">
                <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                    <span>üîá Sensibile (10)</span>
                    <span id="vad-threshold-value" style="font-weight: 600; color: var(--accent);">40</span>
                    <span>Robusto (200) üîä</span>
                </div>
                <small style="color: var(--text-muted); display: block; margin-top: 8px;">
                    Soglia energia per interrompere il TTS quando parli (pi√π basso = pi√π sensibile)
                </small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Sensibilit√† Rilevamento Parlato</label>
                <input type="range" id="speech-threshold" min="20" max="500" value="100" 
                       style="width: 100%;" oninput="updateVoiceSlider('speech-threshold')">
                <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                    <span>üîá Sensibile (20)</span>
                    <span id="speech-threshold-value" style="font-weight: 600; color: var(--accent);">100</span>
                    <span>Robusto (500) üîä</span>
                </div>
                <small style="color: var(--text-muted); display: block; margin-top: 8px;">
                    Soglia energia per rilevare che stai parlando (pi√π basso = pi√π sensibile)
                </small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Soglia Silenzio (frames)</label>
                <input type="range" id="silence-threshold" min="10" max="100" value="30" 
                       style="width: 100%;" oninput="updateVoiceSlider('silence-threshold')">
                <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                    <span>Veloce (10)</span>
                    <span id="silence-threshold-value" style="font-weight: 600; color: var(--accent);">30</span>
                    <span>Paziente (100)</span>
                </div>
                <small style="color: var(--text-muted); display: block; margin-top: 8px;">
                    Frames di silenzio prima di terminare l'ascolto (~50ms per frame)
                </small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Cooldown dopo TTS (secondi)</label>
                <input type="range" id="tts-cooldown" min="0" max="10" value="5" step="0.5"
                       style="width: 100%;" oninput="updateVoiceSlider('tts-cooldown')">
                <div style="display: flex; justify-content: space-between; font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                    <span>0s</span>
                    <span id="tts-cooldown-value" style="font-weight: 600; color: var(--accent);">5s</span>
                    <span>10s</span>
                </div>
                <small style="color: var(--text-muted); display: block; margin-top: 8px;">
                    Tempo di attesa dopo il TTS per evitare eco (audio bufferizzato)
                </small>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveVoiceSettings()">üíæ Salva</button>
                <button class="btn btn-secondary" onclick="resetVoiceDefaults()">üîÑ Reset Default</button>
                <button class="btn btn-primary" onclick="saveAndRestartAgent()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    üöÄ Salva e Riavvia Agent
                </button>
            </div>
            
            <div class="info-box" style="margin-top: 20px; padding: 16px; background: rgba(139, 92, 246, 0.1); border-radius: 12px; border-left: 3px solid var(--accent);">
                <div style="font-weight: 600; margin-bottom: 8px;">üí° Suggerimenti</div>
                <ul style="font-size: 0.85rem; color: var(--text-secondary); margin: 0; padding-left: 20px; line-height: 1.8;">
                    <li><strong>VAD Barge-in</strong>: Se Sophy non si ferma quando parli, abbassa questo valore</li>
                    <li><strong>Rilevamento Parlato</strong>: Se devi urlare per attivare, abbassa questo valore</li>
                    <li><strong>Cooldown TTS</strong>: Se Sophy rileva l'eco delle sue risposte, aumenta questo valore</li>
                    <li><strong>Timeout Hey Sophy</strong>: Tempo di silenzio prima che devi riattivare con "Hey Sophy"</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ==================== State ====================
        let ollamaModels = [];
        let openrouterModels = [];
        let selectedTTS = 'edge';
        
        const stats = {
            stt: { values: [], avg: 0, last: 0, count: 0 },
            llm: { values: [], avg: 0, last: 0, count: 0, ttft: 0 },
            tts: { values: [], avg: 0, last: 0, count: 0 },
            latency: { values: [], avg: 0, last: 0, count: 0 }
        };

        // ==================== Init ====================
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSettings();
            await loadOllamaModels();
            await loadPromptSettings();
            await loadVoiceSettings();
            startStatsPolling();
        });

        // ==================== Tabs ====================
        function switchTab(tabId) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }

        // ==================== Settings ====================
        async function loadSettings() {
            try {
                const resp = await fetch('/api/settings');
                const settings = await resp.json();
                
                // Whisper
                if (settings.whisper_model) {
                    document.getElementById('whisper-model').value = settings.whisper_model;
                }
                if (settings.whisper_language) {
                    document.getElementById('whisper-language').value = settings.whisper_language;
                }
                document.getElementById('whisper-auto-detect').checked = settings.whisper_auto_detect === 'true';
                
                // TTS
                if (settings.tts_engine) {
                    selectTTS(settings.tts_engine);
                }
                if (settings.tts_language) {
                    document.getElementById('tts-language').value = settings.tts_language;
                }
                
                // ElevenLabs
                if (settings.elevenlabs_model) {
                    document.getElementById('elevenlabs-model').value = settings.elevenlabs_model;
                }
                if (settings.elevenlabs_voice) {
                    selectedElevenLabsVoice = settings.elevenlabs_voice;
                }
                if (settings.elevenlabs_stability) {
                    document.getElementById('elevenlabs-stability').value = settings.elevenlabs_stability;
                    document.getElementById('stability-value').textContent = `${settings.elevenlabs_stability}%`;
                }
                if (settings.elevenlabs_similarity) {
                    document.getElementById('elevenlabs-similarity').value = settings.elevenlabs_similarity;
                    document.getElementById('similarity-value').textContent = `${settings.elevenlabs_similarity}%`;
                }
                if (settings.elevenlabs_style) {
                    document.getElementById('elevenlabs-style').value = settings.elevenlabs_style;
                    document.getElementById('style-value').textContent = `${settings.elevenlabs_style}%`;
                }
                if (settings.elevenlabs_boost === 'true') {
                    document.getElementById('elevenlabs-boost').checked = true;
                }
                
                // LLM Provider
                if (settings.llm_provider === 'openrouter') {
                    switchProvider('openrouter');
                } else if (settings.llm_provider === 'remote') {
                    switchProvider('remote');
                }
                
                // Ollama model
                if (settings.ollama_model) {
                    window.savedOllamaModel = settings.ollama_model;
                }
                
                // OpenRouter
                if (settings.openrouter_model) {
                    window.savedOpenRouterModel = settings.openrouter_model;
                }
                if (settings.openrouter_api_key) {
                    const keyInput = document.getElementById('openrouter-key');
                    if (keyInput) keyInput.value = settings.openrouter_api_key;
                }
                
                // Remote Server
                if (settings.remote_server_url) {
                    document.getElementById('remote-server-url').value = settings.remote_server_url;
                }
                if (settings.remote_server_token) {
                    document.getElementById('remote-server-token').value = settings.remote_server_token;
                }
                if (settings.remote_server_collection) {
                    document.getElementById('remote-server-collection').value = settings.remote_server_collection;
                }
                
                // System prompt e context
                if (settings.system_prompt) {
                    const promptInput = document.getElementById('system-prompt');
                    if (promptInput) promptInput.value = settings.system_prompt;
                }
                if (settings.context_injection) {
                    const contextInput = document.getElementById('context-injection');
                    if (contextInput) contextInput.value = settings.context_injection;
                }
                
            } catch (e) {
                console.error('Errore caricamento settings:', e);
            }
        }

        async function saveWhisperSettings() {
            const settings = {
                whisper_model: document.getElementById('whisper-model').value,
                whisper_language: document.getElementById('whisper-language').value,
                whisper_auto_detect: document.getElementById('whisper-auto-detect').checked ? 'true' : 'false'
            };
            
            try {
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ settings })
                });
                showToast('Impostazioni Whisper salvate', 'success');
            } catch (e) {
                showToast('Errore salvataggio', 'error');
            }
        }

        async function saveTTSSettings() {
            const settings = {
                tts_engine: selectedTTS,
                tts_language: document.getElementById('tts-language').value
            };
            
            try {
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ settings })
                });
                
                // Salva anche nella config file per l'agent
                await fetch('/api/tts/current', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        engine: selectedTTS,
                        language: settings.tts_language
                    })
                });
                
                showToast('Impostazioni TTS salvate', 'success');
            } catch (e) {
                showToast('Errore salvataggio', 'error');
            }
        }

        // ==================== LLM Provider ====================
        function switchProvider(provider) {
            document.querySelectorAll('.provider-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`[data-provider="${provider}"]`).classList.add('active');
            
            document.getElementById('ollama-section').style.display = provider === 'ollama' ? 'block' : 'none';
            document.getElementById('openrouter-section').style.display = provider === 'openrouter' ? 'block' : 'none';
            document.getElementById('remote-section').style.display = provider === 'remote' ? 'block' : 'none';
            
            if (provider === 'openrouter' && openrouterModels.length === 0) {
                loadOpenRouterModels();
            }
            
            if (provider === 'remote' && !window.remoteConfigLoaded) {
                loadRemoteConfig();
            }
        }

        // ==================== Ollama ====================
        async function loadOllamaModels() {
            try {
                const resp = await fetch('/api/ollama/models');
                const data = await resp.json();
                ollamaModels = data.models || [];
                renderOllamaModels(ollamaModels);
            } catch (e) {
                document.getElementById('ollama-models').innerHTML = '<div style="color: var(--danger);">Errore caricamento modelli Ollama</div>';
            }
        }

        // Variabile per memorizzare i modelli Ollama visualizzati
        let displayedOllamaModels = [];

        function renderOllamaModels(models) {
            const container = document.getElementById('ollama-models');
            if (models.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted);">Nessun modello trovato</div>';
                displayedOllamaModels = [];
                return;
            }

            displayedOllamaModels = models;
            const savedModel = window.savedOllamaModel || '';

            container.innerHTML = models.map((m, idx) => `
                <div class="model-item ${m.name === savedModel || m.id === savedModel ? 'selected' : ''}" onclick="selectOllamaModelByIndex(${idx}, this)">
                    <div class="model-info">
                        <div class="model-name">${escapeHtml(m.name)} ${m.name === savedModel || m.id === savedModel ? '‚úì' : ''}</div>
                        <div class="model-desc">${formatBytes(m.size)}</div>
                    </div>
                </div>
            `).join('');
        }

        function filterOllamaModels() {
            const search = document.getElementById('ollama-search').value.toLowerCase();
            const filtered = ollamaModels.filter(m => m.name.toLowerCase().includes(search));
            renderOllamaModels(filtered);
        }

        async function selectOllamaModelByIndex(idx, element) {
            const model = displayedOllamaModels[idx];
            if (!model) {
                showToast('Errore: modello non trovato', 'error');
                return;
            }

            try {
                const resp = await fetch('/api/ollama/select', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: model.name || model.id })
                });
                if (!resp.ok) throw new Error('Errore API');

                // Salva modello selezionato
                window.savedOllamaModel = model.name || model.id;
                
                showToast(`Modello ${model.name} selezionato`, 'success');

                document.querySelectorAll('#ollama-models .model-item').forEach(el => el.classList.remove('selected'));
                element.classList.add('selected');
                
                // Aggiorna check nei nomi
                renderOllamaModels(displayedOllamaModels);
            } catch (e) {
                console.error('Errore selezione Ollama:', e);
                showToast('Errore selezione modello', 'error');
            }
        }

        // ==================== OpenRouter ====================
        let allOpenRouterModels = []; // Tutti i modelli caricati dal server
        
        async function loadOpenRouterModels() {
            const search = document.getElementById('openrouter-search')?.value || '';
            
            try {
                const resp = await fetch(`/api/openrouter/models?search=${encodeURIComponent(search)}&sort_by=name`);
                const data = await resp.json();
                allOpenRouterModels = data.models || [];
                filterAndRenderOpenRouter();
            } catch (e) {
                document.getElementById('openrouter-models').innerHTML = '<div style="color: var(--danger);">Errore caricamento modelli</div>';
            }
        }
        
        function updateCostSlider() {
            const slider = document.getElementById('openrouter-max-cost');
            const valueDisplay = document.getElementById('max-cost-value');
            const value = parseFloat(slider.value);
            
            if (value === 0) {
                valueDisplay.textContent = 'üÜì Gratuiti';
                valueDisplay.style.color = '#10b981';
            } else {
                valueDisplay.textContent = `$${value.toFixed(2)}`;
                valueDisplay.style.color = 'var(--primary)';
            }
            
            filterAndRenderOpenRouter();
        }
        
        function filterAndRenderOpenRouter() {
            const maxCost = parseFloat(document.getElementById('openrouter-max-cost')?.value || 100);
            const sort = document.getElementById('openrouter-sort')?.value || 'name';
            
            // Filtra per costo massimo
            let filtered = allOpenRouterModels.filter(m => m.total_cost <= maxCost);
            
            // Ordina
            switch(sort) {
                case 'cost':
                    filtered.sort((a, b) => a.total_cost - b.total_cost);
                    break;
                case 'cost_desc':
                    filtered.sort((a, b) => b.total_cost - a.total_cost);
                    break;
                case 'context':
                    filtered.sort((a, b) => (b.context_length || 0) - (a.context_length || 0));
                    break;
                default: // name
                    filtered.sort((a, b) => a.name.localeCompare(b.name));
            }
            
            renderOpenRouterModels(filtered);
        }

        function renderOpenRouterModels(models) {
            const container = document.getElementById('openrouter-models');
            if (models.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted);">Nessun modello trovato con questi criteri</div>';
                displayedOpenRouterModels = [];
                return;
            }

            // Salva i modelli visualizzati per la selezione
            displayedOpenRouterModels = models.slice(0, 50);
            const savedModel = window.savedOpenRouterModel || '';

            container.innerHTML = displayedOpenRouterModels.map((m, idx) => `
                <div class="model-item ${m.id === savedModel ? 'selected' : ''}" onclick="selectOpenRouterModelByIndex(${idx}, this)">
                    <div class="model-info">
                        <div class="model-name">${escapeHtml(m.name)} ${m.id === savedModel ? '‚úì' : ''}</div>
                        <div class="model-badges">
                            ${m.supports_vision ? '<span class="badge badge-vision">üëÅÔ∏è Vision</span>' : ''}
                            ${m.supports_tools ? '<span class="badge badge-tools">üîß Tools</span>' : ''}
                            ${m.supports_json_mode ? '<span class="badge badge-json">üìã JSON</span>' : ''}
                            <span class="badge badge-context">üìù ${formatContextLength(m.context_length)}</span>
                        </div>
                        <div class="model-desc">${escapeHtml(m.description?.substring(0, 100) || '')}</div>
                        <div class="model-cost" style="color: ${m.total_cost === 0 ? '#10b981' : 'var(--text-muted)'}">
                            ${m.total_cost === 0 ? 'üÜì Gratuito' : '$' + m.total_cost.toFixed(4) + '/1M tokens'}
                            ${m.modality ? ' ‚Ä¢ ' + m.modality : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function formatContextLength(tokens) {
            if (!tokens) return '?';
            if (tokens >= 1000000) return (tokens / 1000000).toFixed(1) + 'M';
            if (tokens >= 1000) return Math.round(tokens / 1000) + 'K';
            return tokens.toString();
        }

        function searchOpenRouterModels() {
            clearTimeout(window.openrouterSearchTimeout);
            window.openrouterSearchTimeout = setTimeout(loadOpenRouterModels, 300);
        }

        async function saveOpenRouterKey() {
            const key = document.getElementById('openrouter-key').value;
            try {
                await fetch('/api/openrouter/key', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_key: key })
                });
                showToast('API Key salvata', 'success');
                loadOpenRouterModels();
            } catch (e) {
                showToast('Errore salvataggio', 'error');
            }
        }

        // Variabile per memorizzare i modelli filtrati visualizzati
        let displayedOpenRouterModels = [];

        async function selectOpenRouterModelByIndex(idx, element) {
            const model = displayedOpenRouterModels[idx];
            if (!model) {
                showToast('Errore: modello non trovato', 'error');
                return;
            }

            try {
                // Passa tutti i dettagli del modello al backend
                const resp = await fetch('/api/openrouter/select', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: model.id,
                        name: model.name,
                        context_length: model.context_length,
                        supports_vision: model.supports_vision,
                        supports_tools: model.supports_tools,
                        supports_json_mode: model.supports_json_mode,
                        modality: model.modality,
                        prompt_cost: model.prompt_cost,
                        completion_cost: model.completion_cost
                    })
                });
                if (!resp.ok) throw new Error('Errore API');

                // Salva modello selezionato
                window.savedOpenRouterModel = model.id;
                
                // Mostra toast con dettagli
                const visionText = model.supports_vision ? ' (Vision ‚úì)' : '';
                const toolsText = model.supports_tools ? ' (Tools ‚úì)' : '';
                showToast(`${model.name}${visionText}${toolsText} - ${formatContextLength(model.context_length)} context`, 'success');

                document.querySelectorAll('#openrouter-models .model-item').forEach(el => el.classList.remove('selected'));
                element.classList.add('selected');
                
                // Aggiorna check nei nomi
                renderOpenRouterModels(displayedOpenRouterModels);
            } catch (e) {
                console.error('Errore selezione OpenRouter:', e);
                showToast('Errore selezione modello', 'error');
            }
        }

        // ==================== Prompt ====================
        async function loadPromptSettings() {
            try {
                const [promptResp, contextResp] = await Promise.all([
                    fetch('/api/prompt'),
                    fetch('/api/context')
                ]);
                
                const promptData = await promptResp.json();
                const contextData = await contextResp.json();
                
                document.getElementById('system-prompt').value = promptData.prompt || '';
                document.getElementById('context-injection').value = contextData.context || '';
            } catch (e) {
                console.error('Errore caricamento prompt:', e);
            }
        }

        async function savePromptSettings() {
            const prompt = document.getElementById('system-prompt').value;
            const context = document.getElementById('context-injection').value;
            
            try {
                await Promise.all([
                    fetch('/api/prompt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    }),
                    fetch('/api/context', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ context })
                    })
                ]);
                showToast('Prompt salvato', 'success');
            } catch (e) {
                showToast('Errore salvataggio', 'error');
            }
        }

        // ==================== TTS ====================
        let elevenLabsVoices = [];
        let selectedElevenLabsVoice = '';
        
        function selectTTS(engine) {
            selectedTTS = engine;
            document.querySelectorAll('.tts-option').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-engine="${engine}"]`)?.classList.add('selected');
            
            // Mostra/nascondi pannello ElevenLabs
            const elevenLabsConfig = document.getElementById('elevenlabs-config');
            if (engine === 'elevenlabs') {
                elevenLabsConfig.style.display = 'block';
                loadElevenLabsVoices();
            } else {
                elevenLabsConfig.style.display = 'none';
            }
        }
        
        function updateElevenLabsSlider(type) {
            const slider = document.getElementById(`elevenlabs-${type}`);
            const valueDisplay = document.getElementById(`${type}-value`);
            valueDisplay.textContent = `${slider.value}%`;
            saveElevenLabsSettings();
        }
        
        async function saveElevenLabsKey() {
            const key = document.getElementById('elevenlabs-key').value;
            try {
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ elevenlabs_api_key: key })
                });
                showToast('API Key ElevenLabs salvata', 'success');
                loadElevenLabsVoices();
            } catch (e) {
                showToast('Errore salvataggio', 'error');
            }
        }
        
        async function loadElevenLabsVoices() {
            const container = document.getElementById('elevenlabs-voices');
            container.innerHTML = '<div class="loading"></div>';
            
            try {
                const resp = await fetch('/api/elevenlabs/voices');
                const data = await resp.json();
                
                if (data.error) {
                    container.innerHTML = `<div style="color: var(--warning);">${data.error}</div>`;
                    return;
                }
                
                elevenLabsVoices = data.voices || [];
                renderElevenLabsVoices(elevenLabsVoices);
            } catch (e) {
                container.innerHTML = '<div style="color: var(--danger);">Errore caricamento voci</div>';
            }
        }
        
        function renderElevenLabsVoices(voices) {
            const container = document.getElementById('elevenlabs-voices');
            if (voices.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted);">Nessuna voce trovata</div>';
                return;
            }
            
            container.innerHTML = voices.map(v => `
                <div class="voice-item ${v.voice_id === selectedElevenLabsVoice ? 'selected' : ''}" 
                     onclick="selectElevenLabsVoice('${v.voice_id}', this)">
                    <span class="voice-icon">${getVoiceIcon(v.labels)}</span>
                    <div class="voice-info">
                        <div class="voice-name">${escapeHtml(v.name)}</div>
                        <div class="voice-labels">${formatVoiceLabels(v.labels)}</div>
                    </div>
                    ${v.preview_url ? `<button class="voice-preview" onclick="event.stopPropagation(); playVoicePreview('${v.preview_url}')">‚ñ∂Ô∏è</button>` : ''}
                </div>
            `).join('');
        }
        
        function getVoiceIcon(labels) {
            if (!labels) return 'üé§';
            const gender = labels.gender?.toLowerCase();
            const accent = labels.accent?.toLowerCase() || '';
            
            if (accent.includes('italian') || accent.includes('italian')) return 'üáÆüáπ';
            if (accent.includes('british')) return 'üá¨üáß';
            if (accent.includes('american')) return 'üá∫üá∏';
            if (gender === 'female') return 'üë©';
            if (gender === 'male') return 'üë®';
            return 'üé§';
        }
        
        function formatVoiceLabels(labels) {
            if (!labels) return '';
            const parts = [];
            if (labels.gender) parts.push(labels.gender);
            if (labels.accent) parts.push(labels.accent);
            if (labels.age) parts.push(labels.age);
            return parts.join(' ‚Ä¢ ');
        }
        
        function searchElevenLabsVoices() {
            const search = document.getElementById('elevenlabs-voice-search').value.toLowerCase();
            const filtered = elevenLabsVoices.filter(v => 
                v.name.toLowerCase().includes(search) ||
                (v.labels?.accent || '').toLowerCase().includes(search) ||
                (v.labels?.gender || '').toLowerCase().includes(search)
            );
            renderElevenLabsVoices(filtered);
        }
        
        function selectElevenLabsVoice(voiceId, element) {
            selectedElevenLabsVoice = voiceId;
            document.querySelectorAll('.voice-item').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
            saveElevenLabsSettings();
            
            const voice = elevenLabsVoices.find(v => v.voice_id === voiceId);
            showToast(`Voce "${voice?.name}" selezionata`, 'success');
        }
        
        function playVoicePreview(url) {
            const audio = new Audio(url);
            audio.play();
        }
        
        async function saveElevenLabsSettings() {
            const settings = {
                elevenlabs_model: document.getElementById('elevenlabs-model').value,
                elevenlabs_voice: selectedElevenLabsVoice,
                elevenlabs_stability: document.getElementById('elevenlabs-stability').value,
                elevenlabs_similarity: document.getElementById('elevenlabs-similarity').value,
                elevenlabs_style: document.getElementById('elevenlabs-style').value,
                elevenlabs_boost: document.getElementById('elevenlabs-boost').checked ? 'true' : 'false'
            };
            
            try {
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
            } catch (e) {
                console.error('Errore salvataggio settings ElevenLabs:', e);
            }
        }
        
        async function loadElevenLabsSettings() {
            try {
                const resp = await fetch('/api/settings');
                const data = await resp.json();
                
                if (data.elevenlabs_model) {
                    document.getElementById('elevenlabs-model').value = data.elevenlabs_model;
                }
                if (data.elevenlabs_voice) {
                    selectedElevenLabsVoice = data.elevenlabs_voice;
                }
                if (data.elevenlabs_stability) {
                    document.getElementById('elevenlabs-stability').value = data.elevenlabs_stability;
                    document.getElementById('stability-value').textContent = `${data.elevenlabs_stability}%`;
                }
                if (data.elevenlabs_similarity) {
                    document.getElementById('elevenlabs-similarity').value = data.elevenlabs_similarity;
                    document.getElementById('similarity-value').textContent = `${data.elevenlabs_similarity}%`;
                }
                if (data.elevenlabs_style) {
                    document.getElementById('elevenlabs-style').value = data.elevenlabs_style;
                    document.getElementById('style-value').textContent = `${data.elevenlabs_style}%`;
                }
                if (data.elevenlabs_boost === 'true') {
                    document.getElementById('elevenlabs-boost').checked = true;
                }
            } catch (e) {
                console.error('Errore caricamento settings ElevenLabs:', e);
            }
        }

        async function testTTS() {
            const text = document.getElementById('tts-test-text').value;
            const status = document.getElementById('tts-test-status');
            status.innerHTML = '<div class="loading"></div> Generazione audio...';
            
            try {
                const resp = await fetch('/api/tts/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        engine: selectedTTS,
                        text: text,
                        language: document.getElementById('tts-language').value
                    })
                });
                
                if (!resp.ok) throw new Error(await resp.text());
                
                const blob = await resp.blob();
                const url = URL.createObjectURL(blob);
                status.innerHTML = `<audio controls autoplay src="${url}"></audio>`;
            } catch (e) {
                status.innerHTML = `<div style="color: var(--danger);">Errore: ${e.message}</div>`;
            }
        }

        // ==================== Stats ====================
        function startStatsPolling() {
            fetchStats();
            setInterval(fetchStats, 2000);
        }

        async function fetchStats() {
            try {
                const resp = await fetch('/api/timing');
                if (!resp.ok) return;
                const data = await resp.json();
                
                if (data.stt?.time_ms > 0) updateStat('stt', data.stt.time_ms, data.stt.count);
                if (data.llm?.time_ms > 0) updateStat('llm', data.llm.time_ms, data.llm.count, data.llm.ttft_ms);
                if (data.tts?.time_ms > 0) updateStat('tts', data.tts.time_ms, data.tts.count, null, data.tts.audio_sec);
                if (data.latency?.e2e_ms > 0) updateStat('latency', data.latency.e2e_ms, data.latency.count);
            } catch (e) {}
        }

        function updateStat(type, value, count, ttft = null, audioSec = null) {
            stats[type].values.push(value);
            if (stats[type].values.length > 20) stats[type].values.shift();
            stats[type].avg = Math.round(stats[type].values.reduce((a, b) => a + b, 0) / stats[type].values.length);
            stats[type].last = value;
            stats[type].count = count;
            
            document.getElementById(`stat-${type}`).textContent = stats[type].avg;
            
            let detail = `Ultimo: ${value}ms | n=${count}`;
            if (ttft) detail += ` | TTFT: ${ttft}ms`;
            if (audioSec) detail += ` | Audio: ${audioSec}s`;
            document.getElementById(`stat-${type}-detail`).textContent = detail;
        }

        async function resetStats() {
            try {
                await fetch('/api/timing/reset', { method: 'POST' });
                ['stt', 'llm', 'tts', 'latency'].forEach(type => {
                    stats[type] = { values: [], avg: 0, last: 0, count: 0 };
                    document.getElementById(`stat-${type}`).textContent = '--';
                    document.getElementById(`stat-${type}-detail`).textContent = 'In attesa...';
                });
                showToast('Stats resettate', 'success');
            } catch (e) {
                showToast('Errore reset', 'error');
            }
        }

        // ==================== Utils ====================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 3000);
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        function formatBytes(bytes) {
            if (!bytes) return 'N/A';
            const gb = bytes / (1024 * 1024 * 1024);
            if (gb >= 1) return `${gb.toFixed(1)} GB`;
            const mb = bytes / (1024 * 1024);
            return `${mb.toFixed(0)} MB`;
        }

        // ==================== Remote Server Functions ====================
        window.remoteConfigLoaded = false;
        
        async function loadRemoteConfig() {
            try {
                const resp = await fetch('/api/remote/config');
                const config = await resp.json();
                
                if (config.server_url) {
                    document.getElementById('remote-server-url').value = config.server_url;
                }
                if (config.token) {
                    document.getElementById('remote-server-token').value = config.token;
                }
                if (config.collection) {
                    document.getElementById('remote-server-collection').value = config.collection;
                }
                
                window.remoteConfigLoaded = true;
            } catch (e) {
                console.error('Errore caricamento config remote:', e);
            }
        }
        
        function toggleTokenVisibility() {
            const tokenInput = document.getElementById('remote-server-token');
            if (tokenInput.type === 'password') {
                tokenInput.type = 'text';
            } else {
                tokenInput.type = 'password';
            }
        }
        
        async function testRemoteServer() {
            const serverUrl = document.getElementById('remote-server-url').value.trim();
            const token = document.getElementById('remote-server-token').value.trim();
            const collection = document.getElementById('remote-server-collection').value.trim();
            
            if (!serverUrl) {
                showToast('Inserisci URL del server', 'error');
                return;
            }
            
            const resultDiv = document.getElementById('remote-test-result');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="loading"></div> Test in corso...';
            resultDiv.style.color = 'var(--text-secondary)';
            
            try {
                const resp = await fetch('/api/remote/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        server_url: serverUrl,
                        token: token,
                        collection: collection
                    })
                });
                
                const result = await resp.json();
                
                if (result.status === 'ok') {
                    resultDiv.innerHTML = `
                        <div style="color: var(--success); font-weight: 600;">‚úÖ Connessione riuscita!</div>
                        <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 4px;">
                            ${result.message || 'Server raggiungibile'}
                            ${result.response_preview ? `<br><em>"${escapeHtml(result.response_preview.substring(0, 100))}..."</em>` : ''}
                        </div>
                    `;
                    showToast('Connessione riuscita!', 'success');
                } else {
                    resultDiv.innerHTML = `
                        <div style="color: var(--danger); font-weight: 600;">‚ùå Errore connessione</div>
                        <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 4px;">
                            ${result.message || 'Impossibile connettersi al server'}
                            ${result.code ? ` (HTTP ${result.code})` : ''}
                        </div>
                    `;
                    showToast('Test fallito: ' + result.message, 'error');
                }
                
            } catch (e) {
                resultDiv.innerHTML = `
                    <div style="color: var(--danger); font-weight: 600;">‚ùå Errore</div>
                    <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 4px;">${e.message}</div>
                `;
                showToast('Errore test: ' + e.message, 'error');
            }
        }
        
        async function loadRemoteCollections() {
            const serverUrl = document.getElementById('remote-server-url').value.trim();
            const token = document.getElementById('remote-server-token').value.trim();
            
            if (!serverUrl) {
                showToast('Inserisci URL del server', 'error');
                return;
            }
            
            try {
                const resp = await fetch(`/api/remote/collections?server_url=${encodeURIComponent(serverUrl)}&token=${encodeURIComponent(token)}`);
                const data = await resp.json();
                
                if (data.collections && data.collections.length > 0) {
                    const listDiv = document.getElementById('remote-collections-list');
                    const gridDiv = document.getElementById('remote-collections-grid');
                    
                    listDiv.style.display = 'block';
                    gridDiv.innerHTML = data.collections.map(coll => `
                        <div class="model-item" style="cursor: pointer; padding: 8px 12px;" onclick="selectRemoteCollection('${escapeHtml(coll)}')">
                            <span>üìÅ ${escapeHtml(coll)}</span>
                        </div>
                    `).join('');
                    
                    showToast(`${data.collections.length} collections trovate`, 'success');
                } else {
                    showToast('Nessuna collection trovata o endpoint non supportato', 'warning');
                }
                
            } catch (e) {
                showToast('Errore caricamento collections: ' + e.message, 'error');
            }
        }
        
        function selectRemoteCollection(collection) {
            document.getElementById('remote-server-collection').value = collection;
            showToast(`Collection "${collection}" selezionata`, 'success');
        }
        
        // ==================== Voice Activation ====================
        function updateVoiceSlider(id) {
            const slider = document.getElementById(id);
            const valueDisplay = document.getElementById(`${id}-value`);
            const value = slider.value;
            
            if (id === 'wake-timeout') {
                valueDisplay.textContent = `${value}s`;
            } else if (id === 'tts-cooldown') {
                valueDisplay.textContent = `${value}s`;
            } else {
                valueDisplay.textContent = value;
            }
        }
        
        async function loadVoiceSettings() {
            try {
                const resp = await fetch('/api/settings');
                const settings = await resp.json();
                
                if (settings.wake_timeout_seconds) {
                    document.getElementById('wake-timeout').value = settings.wake_timeout_seconds;
                    document.getElementById('wake-timeout-value').textContent = `${settings.wake_timeout_seconds}s`;
                }
                if (settings.vad_energy_threshold) {
                    document.getElementById('vad-threshold').value = settings.vad_energy_threshold;
                    document.getElementById('vad-threshold-value').textContent = settings.vad_energy_threshold;
                }
                if (settings.speech_energy_threshold) {
                    document.getElementById('speech-threshold').value = settings.speech_energy_threshold;
                    document.getElementById('speech-threshold-value').textContent = settings.speech_energy_threshold;
                }
                if (settings.silence_threshold) {
                    document.getElementById('silence-threshold').value = settings.silence_threshold;
                    document.getElementById('silence-threshold-value').textContent = settings.silence_threshold;
                }
                if (settings.tts_cooldown_seconds) {
                    document.getElementById('tts-cooldown').value = settings.tts_cooldown_seconds;
                    document.getElementById('tts-cooldown-value').textContent = `${settings.tts_cooldown_seconds}s`;
                }
            } catch (e) {
                console.error('Errore caricamento voice settings:', e);
            }
        }
        
        async function saveVoiceSettings() {
            const settings = {
                wake_timeout_seconds: document.getElementById('wake-timeout').value,
                vad_energy_threshold: document.getElementById('vad-threshold').value,
                speech_energy_threshold: document.getElementById('speech-threshold').value,
                silence_threshold: document.getElementById('silence-threshold').value,
                tts_cooldown_seconds: document.getElementById('tts-cooldown').value
            };
            
            try {
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ settings })
                });
                showToast('Impostazioni Voice salvate! Riavvia l\'agent per applicare.', 'success');
            } catch (e) {
                showToast('Errore salvataggio', 'error');
            }
        }
        
        function resetVoiceDefaults() {
            document.getElementById('wake-timeout').value = '20';
            document.getElementById('wake-timeout-value').textContent = '20s';
            document.getElementById('vad-threshold').value = '40';
            document.getElementById('vad-threshold-value').textContent = '40';
            document.getElementById('speech-threshold').value = '100';
            document.getElementById('speech-threshold-value').textContent = '100';
            document.getElementById('silence-threshold').value = '30';
            document.getElementById('silence-threshold-value').textContent = '30';
            document.getElementById('tts-cooldown').value = '5';
            document.getElementById('tts-cooldown-value').textContent = '5s';
            showToast('Valori di default ripristinati (non salvati)', 'success');
        }
        
        async function saveAndRestartAgent() {
            // Prima salva i settings
            await saveVoiceSettings();
            
            showToast('‚è≥ Riavvio agent in corso...', 'success');
            
            try {
                const resp = await fetch('/api/agent/restart', {
                    method: 'POST'
                });
                const result = await resp.json();
                
                if (result.status === 'ok') {
                    showToast('‚úÖ Agent riavviato! I nuovi settings sono attivi.', 'success');
                } else {
                    showToast('‚ùå Errore: ' + result.message, 'error');
                }
            } catch (e) {
                showToast('‚ùå Errore riavvio: ' + e.message, 'error');
            }
        }
        
        async function restartAgentOnly() {
            showToast('‚è≥ Riavvio agent in corso...', 'success');
            
            try {
                const resp = await fetch('/api/agent/restart', {
                    method: 'POST'
                });
                const result = await resp.json();
                
                if (result.status === 'ok') {
                    showToast('‚úÖ Agent riavviato!', 'success');
                } else {
                    showToast('‚ùå Errore: ' + result.message, 'error');
                }
            } catch (e) {
                showToast('‚ùå Errore riavvio: ' + e.message, 'error');
            }
        }
        
        async function saveRemoteServer() {
            const serverUrl = document.getElementById('remote-server-url').value.trim();
            const token = document.getElementById('remote-server-token').value.trim();
            const collection = document.getElementById('remote-server-collection').value.trim();
            
            if (!serverUrl) {
                showToast('Inserisci URL del server', 'error');
                return;
            }
            
            try {
                const resp = await fetch('/api/remote/select', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        server_url: serverUrl,
                        token: token,
                        collection: collection
                    })
                });
                
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.detail || 'Errore salvataggio');
                }
                
                showToast('Server remoto configurato! Riavvia l\'agent per applicare.', 'success');
                
            } catch (e) {
                showToast('Errore salvataggio: ' + e.message, 'error');
            }
        }
    </script>
</body>
</html>
